<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Крид</title>

    <link rel="stylesheet" href="/css/style.css">

    <script src="/js/jquery.min.js"></script>
    <script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
    <script src="/js/preloadjs-0.6.2.min.js" type="text/javascript"></script>

    <link rel="icon" type="image/png" href="favicon.png?v=a">
</head>
<body>
{#<script>#}
    {#window.fbAsyncInit = function() {#}
        {#FB.init({#}
            {#appId      : 1536863159967920,#}
            {#xfbml      : true,#}
            {#version    : 'v2.5'#}
        {#});#}
    {#};#}
    {#(function(d, s, id){#}
        {#var js, fjs = d.getElementsByTagName(s)[0];#}
        {#if (d.getElementById(id)) {return;}#}
        {#js = d.createElement(s); js.id = id;#}
        {#js.src = "//connect.facebook.net/en_US/sdk.js";#}
        {#fjs.parentNode.insertBefore(js, fjs);#}
    {#}(document, 'script', 'facebook-jssdk'));#}
{#</script>#}
<script>
    VK.init({apiId: 4905664});
    var progress = 0;
    var files = [
        '/img/bg.png',
        '/img/button.bg.png',
        '/img/copy.png',
        '/img/creators.png',
        '/img/date.png',
        '/img/download.png',
        '/img/example.hashtag.png',
        '/img/fb.png',
        '/img/instagram.png',
        '/img/ok.png',
        '/img/reload.png',
        '/img/share.fb.png',
        '/img/share.png',
        '/img/share.twitter.png',
        '/img/share.vk.png',
        '/img/title.png',
        '/img/twitter.png',
        '/img/user.hashtag.png',
        '/img/vk.png',
        '/img/youtube.png'
    ];

    var queue = new createjs.LoadQueue(true);
    queue.on('complete', function(){
        $('.overlay').hide();
    });
    queue.on('fileload',function(e){
        var step = parseInt(100 / files.length);
        progress = progress + step;
        $('.percent').html(progress + '%');
    });
    queue.loadManifest(files);



    $(function(){
        var doVkPost = function(){





//            VK.Api.call('wall.post',{
//                'friends_only': 0,
//                'message':'#ГотовБоротьсяЗа'
//            },function(r){
//                console.log(r);
//            })
        };


        $('.take-photo').hide();

        $(".user-hashtag").keyup(function() {
            this.value = this.value.replace(/[^а-яё]/i, "");

            if(this.value.length > 0){
                $('.instructions').hide();
                $('.take-photo').show();
            }else{
                $('.instructions').show();
                $('.take-photo').hide();
            }
        });

        $(document).on('click tap','.share',function(e){
            e.preventDefault();

            $('.buttons').hide();
            $('.share-buttons').show();
        });


        $(document).on('click tap','.share-vk',function(e){
            e.preventDefault();

            VK.Auth.login(function(loginResponse){
                console.log(loginResponse);


                VK.Api.call('photos.getWallUploadServer',{},function(r){
                    if(r.response.upload_url){
                        $.ajax({
                            method: 'post',
                            url: '/vkPostImage',
                            data:{
                                vk_post_url: r.response.upload_url,
                                photo: $('.download').attr('href')
                            },
                            success: function(e){

                                console.log(e);
                            }
                        })
                    }

                    console.log(r);
                });
            },8196);
        });

        $(document).on('click tap','.share-fb',function(e){
            e.preventDefault();

            FB.getLoginStatus(function(response) {
                if (response.status === 'connected') {
                    console.log(response);
                }
                else {
                    FB.login();
                }
            });
        });

        $(document).on('click tap','.share-twitter',function(e){
            e.preventDefault();
            $.ajax({
                method: 'post',
                url: '/authTwitter',
                data:{
                    photo: $('.download').attr('href')
                },
                success: function(e){
                    if(e.url){
                        location.href = e.url;
                    }
                }
            })
        });



//        $(document).on('click tap','.social-share',function(e){
//            e.preventDefault();
//
//            $.ajax({
//                method: 'post',
//                url: '/',
//                data: {
//                    image: $('.download').attr('href'),
//                    type: $(this).attr('data-type')
//                },
//                success: function(e){
//                    if(e.auth){
//                        location.href = e.auth;
//                    }
//                }
//            })
//        });

        $(document).on('change','#photo',function(){
            if(this.files && this.files[0]){
                var reader = new FileReader();
                var canvas = document.getElementById('preview-canvas');
                var context = canvas.getContext('2d');

                reader.readAsDataURL(this.files[0]);
                reader.onload = function(_file){
                    var image = new Image();
                    image.src = _file.target.result;
                    image.onload = function(){

                        $('.main').addClass('backed');
                        $('.preview').show();

                        var imageRatio = image.width / image.height;
                        var sourceWidth = 1334 * imageRatio;
                        var sourceHeight = 1334;

                        context.drawImage(image, -((sourceWidth - canvas.width) / 2),0,sourceWidth,sourceHeight);

                        var exampleHashTag = new Image();
                        exampleHashTag.src = '/img/example.hashtag.png';

                        exampleHashTag.onload = function(){
                            context.drawImage(exampleHashTag,(canvas.width - exampleHashTag.width) / 2,canvas.height - exampleHashTag.height - 150);

                            context.font = "65px pf_din_text_cond_probold";
                            context.fillStyle = '#9e040c';
                            context.fillText("# ГотовБоротьсяЗа",(canvas.width - exampleHashTag.width) / 2 + 25,canvas.height - exampleHashTag.height - 75);

                            var userHashTag = new Image();
                            userHashTag.src = '/img/example.hashtag.png';

                            userHashTag.onload = function(){
                                context.drawImage(userHashTag,(canvas.width - userHashTag.width) / 2,canvas.height - userHashTag.height - 25);

                                context.font = "65px pf_din_text_cond_probold";
                                context.fillStyle = '#000';
                                context.textAlign = 'center';
                                context.fillText($('.user-hashtag').val().toUpperCase(),canvas.width / 2,canvas.height - 60);

                                $('.download').attr('href',canvas.toDataURL());
                            };
                        };
                    }
                };
            }
        });
    })
</script>
<div class="overlay">
    <div class="percent">0%</div>
</div>
<div class="main">
    <div class="copyright"></div>
    <div class="social">
        <a href="" target="_blank" class="icon youtube"></a>
        <a href="" target="_blank" class="icon vk"></a>
        <a href="" target="_blank" class="icon fb"></a>
        <a href="" target="_blank" class="icon twitter"></a>
        <a href="" target="_blank" class="icon instagram"></a>
        <a href="" target="_blank" class="icon ok"></a>
    </div>
    <div class="creators"></div>
    <div class="title"></div>
    <div class="date"></div>

    <div class="bottom">
        <div class="example-hashtag"># ГотовБоротьсяЗа</div>
        <input type="text" class="user-hashtag">
        <div class="instructions">Инструкции</div>
        <label class="take-photo">
            <span>Сделать фото +</span>
            <input id="photo" type="file" accept="image/*; capture=camera">
        </label>
        <div class="footer">
            <div class="age">16+</div>
            <ul>
                <li><a href="">Создатели</a></li>
                <li><a href="">Правила пользования</a></li>
                <li><a href="">Политика конфиденциальности</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="preview">
    <canvas width="750" height="1334" id="preview-canvas"></canvas>
    <div class="buttons">
        <a href="" class="reload"></a>
        <a href="" class="download" target="_blank" download="#ГотовБоротьсяЗа"></a>
        <a href="" class="share"></a>
    </div>
    <div class="share-buttons">
        <a href="" data-type="vk" class="social-share share-vk"></a>
        <a href="" data-type="fb" class="social-share share-fb"></a>
        <a href="" data-type="twitter" class="social-share share-twitter"></a>
    </div>
</div>
</body>
</html>