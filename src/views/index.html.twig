<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Крид: Наследие Рокки – Расскажи о своем кредо</title>
    <meta name="keywords" content="кино, спорт, бокс, Рокки, Рокки Бальбоа, Крид Наследие Рокки, Крид, фильм, фильмы 2016">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/js/jquery.min.js"></script>
    <script src="//vk.com/js/api/openapi.js" type="text/javascript"></script>
    <script src="/js/preloadjs-0.6.2.min.js" type="text/javascript"></script>
    <script src="/js/hermite.js" type="text/javascript"></script>

    <link rel="icon" type="image/png" href="favicon.png?v=a">
</head>
<body>
<script>
    window.fbAsyncInit = function() {
        FB.init({
            appId      : 1536863159967920,
            xfbml      : true,
            version    : 'v2.5'
        });
    };
    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<script>
    VK.init({apiId: 5200246});
    var progress = 0;
    var files = [
        '/img/bg.png',
        '/img/bg2.png',
        '/img/button.bg.png',
        '/img/copy.png',
        '/img/creators.png',
        '/img/date.png',
        '/img/download.png',
        '/img/example.hashtag.png',
        '/img/fb.png',
        '/img/instagram.png',
        '/img/ok.png',
        '/img/reload.png',
        '/img/share.fb.png',
        '/img/share.png',
        '/img/share.twitter.png',
        '/img/share.vk.png',
        '/img/title.png',
        '/img/twitter.png',
        '/img/user.hashtag.png',
        '/img/vk.png',
        '/img/youtube.png',
        '/img/watch.png',
        '/img/camera.png',
        '/img/ajax-loader.gif'
    ];

    var queue = new createjs.LoadQueue(true);

    queue.on('complete', function(){
        $('.overlay').hide();
    });

    queue.on('fileload',function(e){
        var step = parseInt(100 / files.length);
        progress = progress + step;
        $('.percent').html(progress + '%');
    });
    queue.loadManifest(files);

    $(function(){
        var loader                  = $('.loader-wrapper');
        var userHashtagInput        = $(".user-hashtag");

        var imageURL;
        var imageVkId;

        $('.take-photo').hide();
        if('FileReader' in window == false || 'FormData' in window == false){
            userHashtagInput.hide();
            $('.instructions').hide();
        }

        var publishImage = function(){
            VK.Api.call('photos.getWallUploadServer', {}, function (r1) {
                if (r1.response.upload_url) {
                    try {
                        var imageData = document.getElementById('preview-canvas').toDataURL('image/png');

                        $.ajax({
                            url: '/vkPostImage',
                            method: 'post',
                            data: {
                                photo: imageData,
                                url: r1.response.upload_url
                            },
                            cache: false,
                            success: function (e) {
                                var uploadResult = e;
                                VK.Api.call('photos.saveWallPhoto', {
                                    photo: uploadResult.photo,
                                    server: uploadResult.server,
                                    hash: uploadResult.hash
                                }, function (r2) {
                                    loader.hide();

                                    console.log(r2);

                                    imageVkId = r2.response[0].id;
                                    imageURL  = r2.response[0].src_big;

                                    $('.download').attr('href',imageURL);

                                    $('.buttons').hide();
                                    $('.share-buttons').show();
                                })
                            },
                            error: function (e) {
                                console.log(e);
                            }
                        });
                    } catch (e) {
                        console.log(e);
                    }
                }
            });
        };

        var postVk = function(){
            loader.show();

            VK.Api.call('wall.post',{
                'friends_only': 0,
                'message':'#ГотовБоротьсяЗа #IFightFor #КридРокки',
                'attachments': imageVkId
            },function(r3){
                if(r3.response.post_id){
                    location.href = 'https://vk.com';
                }
            })
        };

        var postFb = function(){
            loader.show();

            FB.api('/me/photos','POST',{
                'url': imageURL,
                'caption':'#ГотовБоротьсяЗа #IFightFor #КридРокки'
            },function(r){
                location.href = 'https://facebook.com/profile.php';
            })
        };

        var postTwitter = function(){
            loader.show();

            $.ajax({
                method: 'post',
                url: '/authTwitter',
                data:{
                    photo: imageURL
                },
                success: function(e){
                    if(e.url){
                        location.href = e.url;
                    }
                }
            })
        };


        userHashtagInput.keyup(function() {
            this.value = this.value.replace(/[^а-яё]/i, "");

            if(this.value.length > 0){
                $('.instructions').hide();
                $('.take-photo').show();
            }else{
                $('.instructions').show();
                $('.take-photo').hide();
            }
        });

        $(document).on('click tap','.instructions',function(e){
            e.preventDefault();
            $('.instructions-wrapper').show();
            $('.main').hide();
        });

        $(document).on('click tap','.reload',function(e){
            e.preventDefault();
            $('.preview').hide();
        });

        $(document).on('click tap','.creators-list-toggle',function(e){
            e.preventDefault();
            $('.creators-list').show();
        });

        $(document).on('click tap','.creators-list',function(e){
            e.preventDefault();
            $('.creators-list').hide();
        });

        $(document).on('click tap','.ok',function(e){
            $('.instructions-wrapper').hide();
            $('.main').show();
        });

        $(document).on('click tap','.share',function(e){
            e.preventDefault();
            loader.show();

            VK.Auth.login(function(r){
                publishImage();
            },8196);
        });


        $(document).on('click tap','.share-vk',function(e){
            e.preventDefault();
            postVk();
        });

        $(document).on('click tap','.share-fb',function(e){
            e.preventDefault();

            FB.getLoginStatus(function(response) {
                if (response.status === 'connected') {
                    console.log(response);
                    postFb();
                }else{
                    FB.login(function(response){
                        console.log(response);
                        postFb();
                    },{scope: 'publish_actions'});
                }
            });
        });

        $(document).on('click tap','.share-twitter',function(e){
            e.preventDefault();
            postTwitter();
        });

        $(document).on('change','#photo',function(){

            if(this.files && this.files[0]){
                var reader = new FileReader();
                var canvas = document.getElementById('preview-canvas');
                var context = canvas.getContext('2d');
                var h = Hermite.init('worker.js');

                context.clearRect(0, 0, canvas.width, canvas.height);
                reader.readAsDataURL(this.files[0]);
                reader.onload = function(_file){
                    var image = new Image();
                    image.src = _file.target.result;

                    image.onload = function(){
                        h.resize({
                            source: image,
                            width: image.width / 2,
                            height: image.height / 2
                        },function(reszied){
                            $('.preview').show();

                            var imageRatio = reszied.width / reszied.height;
                            var sourceWidth = 667 * imageRatio;
                            var sourceHeight = 667;


                            context.drawImage(reszied, -((sourceWidth - canvas.width) / 2),0,sourceWidth,sourceHeight);

                            var exampleHashTag = new Image();
                            exampleHashTag.src = '/img/example.hashtag.png';

                            exampleHashTag.onload = function(){
                                h.resize({
                                    source: exampleHashTag,
                                    width: exampleHashTag.width / 2,
                                    height: exampleHashTag.height / 2
                                },function(output) {
                                    exampleHashTag = output;

                                    context.drawImage(exampleHashTag,(canvas.width - exampleHashTag.width) / 2,canvas.height - exampleHashTag.height - 100);

                                    context.font = "32px pf_din_text_cond_probold";
                                    context.fillStyle = '#9e040c';
                                    context.fillText("# ГотовБоротьсяЗа",(canvas.width - exampleHashTag.width) / 2 + 25,canvas.height - exampleHashTag.height - 60);

                                    var userHashTag = new Image();
                                    userHashTag.src = '/img/example.hashtag.png';

                                    userHashTag.onload = function(){
                                        h.resize({
                                            source: userHashTag,
                                            width: userHashTag.width / 2,
                                            height: userHashTag.height / 2
                                        },function(output){
                                            userHashTag = output;
                                            context.drawImage(userHashTag,(canvas.width - userHashTag.width) / 2,canvas.height - userHashTag.height - 25);

                                            context.font = "32px pf_din_text_cond_probold";
                                            context.fillStyle = '#000';
                                            context.textAlign = 'center';
                                            context.fillText($('.user-hashtag').val().toUpperCase(),canvas.width / 2,canvas.height - 40);
                                        });
                                    };
                                });
                            };
                        });
                    }
                };
            }
        });
    })
</script>
<div class="overlay">
    <div class="percent">0%</div>
</div>
<div class="loader-wrapper">
    <div class="loader-inner">
        Загрузка
        <div class="loader"></div>
    </div>
</div>
<div class="main">
    <div class="copyright"></div>
    <div class="social">
        <a href="" target="_blank" class="icon youtube"></a>
        <a href="http://vk.com/wbrussia" target="_blank" class="icon vk"></a>
        <a href="https://www.facebook.com/wbrussia?_rdr=p" target="_blank" class="icon fb"></a>
        <a href="https://twitter.com/warnerBrosRu" target="_blank" class="icon twitter"></a>
        <a href="" target="_blank" class="icon instagram"></a>
        <a href="" target="_blank" class="icon ok"></a>
    </div>
    <div class="creators"></div>
    <div class="title"></div>
    <div class="date"></div>

    <div class="bottom">
        <div class="example-hashtag"># ГотовБоротьсяЗа</div>
        <input type="text" class="user-hashtag">
        <div class="instructions">Инструкции</div>
        <label class="take-photo">
            <span>Сделать фото +</span>
            <input id="photo" type="file" accept="image/*; capture=camera">
        </label>
        <div class="footer">
            <div class="age">16+</div>
            <ul>
                <li><a href="" class="creators-list-toggle">Создатели</a></li>
                <li><a target="_blank" href="http://www.warnerbros.com/term-use">Правила пользования</a></li>
                <li><a target="_blank" href="http://www.warnerbros.com/privacy-center-wb-privacy-policy">Политика конфиденциальности</a></li>
            </ul>
        </div>
        <div class="creators-list"></div>
    </div>
</div>

<div class="preview">
    <canvas width="375" height="667" id="preview-canvas"></canvas>
    <div class="buttons">
        <a href="" class="reload"></a>
        <a href="" class="download" target="_blank" download="#ГотовБоротьсяЗа"></a>
        <a href="" class="share"></a>
    </div>
    <div class="share-buttons">
        <a href="" data-type="vk" class="social-share share-vk"></a>
        <a href="" data-type="fb" class="social-share share-fb"></a>
        <a href="" data-type="twitter" class="social-share share-twitter"></a>
    </div>
</div>

<div class="instructions-wrapper">
    <h2>
        Инструкции
    </h2>
    <p>
        Расскажи за что ты готов бороться, добавив подпись к хэштегу <a href="">#ГотовБоротьсяЗа</a>. Загрузи фото и поделись результатом с друзьями.
    </p>
    <p>
        Разместив свою работу во ВКонтакте, ты участвуешь в розыгрыше легендарных
        часов Casio G-SHOCK.
    </p>
    <img src="/img/watch.png" class="watch">
    <p>
        Подробнее о конкурсе
        на официальной странице студии
    </p>
    <a target="_blank" class="public" href="http://vk.com/wbrussia">
        <i class="icon vk"></i>
        <span>WBRussia</span>
    </a>

    <div class="ok">
        OK
    </div>
</div>
</body>
</html>